{% if is_mobile %}
<!-- Mobile Cards -->
<div class="px-4 max-w-full">
    {% for patient in patients %}
    <div class="bg-white shadow rounded-lg overflow-hidden mb-4 w-full">
        <div class="p-4">
            <div class="flex items-center justify-between">
                <div class="min-w-0 flex-1">
                    <h3 class="text-lg font-medium text-gray-900 truncate">{{ patient.first_name }} {{ patient.last_name }}</h3>
                    <p class="text-sm text-gray-500">{{ patient.nhs_number }}</p>
                </div>
                {% with active_med=patient.medications.all|first %}
                    {% if active_med %}
                        {% with status=active_med.get_status %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium shrink-0 ml-2
                                {% if status == 'green' %}bg-green-100 text-green-800
                                {% elif status == 'amber' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ active_med.get_status_display_name }}
                            </span>
                        {% endwith %}
                    {% endif %}
                {% endwith %}
            </div>
            
            {% with active_med=patient.medications.all|first %}
            {% if active_med %}
            <dl class="mt-4 grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <div class="col-span-2">
                    <dt class="font-medium text-gray-500">Disease</dt>
                    <dd class="text-gray-900">{{ active_med.medication.disease|default:"Not specified" }}</dd>
                </div>
                <div class="col-span-2">
                    <dt class="font-medium text-gray-500">Medication</dt>
                    <dd class="text-gray-900">{{ active_med.medication.name }}</dd>
                    <dd class="text-gray-500">{{ active_med.dose }}</dd>
                </div>
                <div class="col-span-2">
                    <dt class="font-medium text-gray-500">Next Due</dt>
                    <dd class="text-gray-900">
                        {% if active_med.next_appointment %}
                            {{ active_med.next_appointment|date:"d M Y" }}
                        {% else %}
                            Not scheduled
                        {% endif %}
                    </dd>
                </div>
            </dl>
            {% else %}
            <div class="mt-4 text-sm text-gray-500">No active medications</div>
            {% endif %}
            {% endwith %}
        </div>
        
        <div class="border-t border-gray-200 bg-gray-50 px-4 py-3 flex justify-end space-x-3">
            <a href="{% url 'patients:patient_detail' patient.id %}" 
               class="text-sm font-medium text-blue-600 hover:text-blue-900">View</a>
            <button hx-delete="{% url 'patients:delete_patient' patient.id %}"
                    hx-confirm="Are you sure you want to delete this patient?"
                    hx-target="closest div.bg-white"
                    hx-swap="outerHTML swap:1s"
                    class="text-sm font-medium text-red-600 hover:text-red-900">Delete</button>
        </div>
    </div>
    {% empty %}
    <div class="text-center text-gray-500 py-4">
        No patients found
    </div>
    {% endfor %}
</div>
{% else %}
<!-- Desktop Table -->
<div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 rounded-lg">
    <table class="min-w-full divide-y divide-gray-300">
        <thead class="bg-gray-50">
            <tr>
                <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">
                    PATIENT
                    <button hx-get="{% url 'patients:patient_list' %}?sort=name"
                            hx-target="#patientTableContainer"
                            class="ml-2 text-blue-600 hover:text-blue-800">↓</button>
                </th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                    DISEASE
                    <button hx-get="{% url 'patients:patient_list' %}?sort=disease"
                            hx-target="#patientTableContainer"
                            class="ml-2 text-blue-600 hover:text-blue-800">↓</button>
                </th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">MEDICATION</th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                    NEXT APPOINTMENT
                    <button hx-get="{% url 'patients:patient_list' %}?sort=next_appointment"
                            hx-target="#patientTableContainer"
                            class="ml-2 text-blue-600 hover:text-blue-800">↓</button>
                </th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">STATUS</th>
                <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                    <span class="sr-only">Actions</span>
                </th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 bg-white">
            {% for patient in patients %}
            <tr>
                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 sm:pl-6">
                    {{ patient.first_name }} {{ patient.last_name }}
                    <div class="text-gray-500">{{ patient.nhs_number }}</div>
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    {% with active_med=patient.medications.all|first %}
                        {% if active_med %}
                            {{ active_med.medication.disease|default:"Not specified" }}
                        {% else %}
                            Not specified
                        {% endif %}
                    {% endwith %}
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    {% with active_med=patient.medications.all|first %}
                        {% if active_med %}
                            <div class="font-medium text-gray-900">{{ active_med.medication.name }}</div>
                            <div class="text-gray-500">{{ active_med.dose }}</div>
                        {% else %}
                            No active medications
                        {% endif %}
                    {% endwith %}
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm">
                    {% with active_med=patient.medications.all|first %}
                        {% if active_med and active_med.next_appointment %}
                            {{ active_med.next_appointment|date:"d M Y" }}
                        {% else %}
                            Not scheduled
                        {% endif %}
                    {% endwith %}
                </td>
                <td class="px-3 py-4 whitespace-nowrap">
                    {% with active_med=patient.medications.all|first %}
                        {% if active_med %}
                            {% with status=active_med.get_status %}
                                <p class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                    {% if status == 'green' %}bg-green-100 text-green-800
                                    {% elif status == 'amber' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ active_med.get_status_display_name }}
                                </p>
                            {% endwith %}
                        {% else %}
                            <p class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                No medication
                            </p>
                        {% endif %}
                    {% endwith %}
                </td>
                <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                    <div class="flex justify-end space-x-3">
                        <a href="{% url 'patients:patient_detail' patient.id %}" 
                           class="text-blue-600 hover:text-blue-900">View</a>
                        <button hx-delete="{% url 'patients:delete_patient' patient.id %}"
                                hx-confirm="Are you sure you want to delete this patient?"
                                hx-target="closest tr"
                                hx-swap="outerHTML swap:1s"
                                class="text-red-600 hover:text-red-900">Delete</button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                    No patients found
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
